@model WebBanSach.Models.Data.Sach

@{
    ViewBag.Title = "Chi tiết sách";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Điểm trung bình và số lượt đánh giá, controller set vào ViewBag
    double avgRating = ViewBag.AvgRating != null ? (double)ViewBag.AvgRating : 0;
    int ratingCount = ViewBag.RatingCount != null ? (int)ViewBag.RatingCount : 0;
}
@if (TempData["CartError"] != null)
{
    <div class="alert alert-danger mt-3">
        @TempData["CartError"]
    </div>
}

@if (ViewBag.RatingMessage != null)
{
    <div class="alert alert-success mt-3">
        @ViewBag.RatingMessage
    </div>
}

<div class="row" style="margin-top:20px;">
    <!-- Ảnh sách -->
    <div class="col-md-4">
        <img src="@Url.Content("~/images/" + Model.AnhBia)"
             alt="@Model.TenSach"
             class="img-responsive"
             style="border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.12);" />
    </div>

    <!-- Thông tin sách -->
    <div class="col-md-8">
        <h2 style="margin-top:0; font-weight:600; color:#333;">@Model.TenSach</h2>

        @* HIỂN THỊ SAO ĐÃ ĐƯỢC ĐÁNH GIÁ CHO SÁCH NÀY *@
        @if (ratingCount > 0)
        {
            <div style="margin:5px 0 10px 0;">
                <span style="font-size:16px; font-weight:600; color:#f0ad4e;">
                    @avgRating.ToString("0.0")/5
                </span>
                <span style="margin-left:8px;">
                    @for (int i = 1; i <= 5; i++)
                    {
                        if (i <= Math.Round(avgRating))
                        {
                            @:<i class="fa fa-star" style="color:#f0ad4e;"></i>
                        }
                        else
                        {
                            @:<i class="fa fa-star-o" style="color:#f0ad4e;"></i>
                        }
                    }
                </span>
                <span style="color:#777; font-size:13px; margin-left:5px;">
                    ( @ratingCount đánh giá )
                </span>
            </div>
        }

        <p style="font-size:15px; color:#777; margin-bottom:4px;">
            <strong>Thể loại:</strong> @Model.TheLoai.TenLoai
            &nbsp; | &nbsp;
            <strong>Tác giả:</strong> @Model.TacGia.TenTG
        </p>
        <p style="font-size:14px; color:#777; margin-bottom:12px;">
            <strong>Nhà xuất bản:</strong> @Model.NhaXuatBan.TenNXB
        </p>

        <p style="margin-top:10px; line-height:1.6; font-size:14px; color:#555;">
            @Model.Mota
        </p>

        <br />

        @if (Model.GiaBan > 0)
        {
            <h3 style="color:#d9534f; font-weight:700;">
                Giá - @String.Format("{0:0,0}", Model.GiaBan) VND
            </h3>
        }
        else
        {
            <h3>Giá - Liên hệ</h3>
        }

        @{
            var soTon = Model.SoLuongTon ?? 0;
            var conHang = soTon > 0;
        }

        <p style="margin-top:6px; font-size:14px;">
            <strong>Tình trạng:</strong>
            @if (conHang)
            {
                <span style="color:#5cb85c; font-weight:600;">Còn hàng</span>
                <span style="color:#999; font-size:13px;">(Còn @soTon sản phẩm)</span>
            }
            else
            {
                <span style="color:#d9534f; font-weight:600;">Hết hàng</span>
            }
        </p>

        @* FORM THÊM VÀO GIỎ *@
        @if (conHang)
        {
            using (Html.BeginForm("AddItem", "Cart", FormMethod.Get, new { @class = "form-inline", style = "margin-top:10px;" }))
            {
                @Html.Hidden("id", Model.MaSach)

                <label for="quantity" style="margin-right:8px; font-weight:600;">Số lượng:</label>
                <input type="number"
                       id="quantity"
                       name="quantity"
                       value="1"
                       min="1"
                       class="form-control"
                       style="width:80px; display:inline-block; margin-right:12px;" />

                <button type="submit"
                        class="btn btn-warning btn-large"
                        style="padding:8px 20px; border-radius:20px; font-weight:600;">
                    THÊM VÀO GIỎ HÀNG
                </button>
            }
        }
        else
        {
            <p class="text-danger" style="margin-top:10px; font-weight:600;">
                Sản phẩm đã hết hàng, không thể thêm vào giỏ.
            </p>
        }
    </div>
</div>

@* ====== KHỐI ĐÁNH GIÁ SẢN PHẨM (RATING + REVIEW) ====== *@
<div class="row" style="margin-top:30px;">
    <div class="col-md-12">
        <h3 style="margin-bottom:15px;">
            <i class="fa fa-star"></i> Đánh giá sản phẩm
        </h3>

        <div style="margin-bottom:15px;">
            @if (ratingCount > 0)
            {
                <span style="font-size:16px; font-weight:600; color:#f0ad4e;">
                    @avgRating.ToString("0.0")/5
                </span>
                <span>
                    @for (int i = 1; i <= 5; i++)
                    {
                        if (i <= Math.Round(avgRating))
                        {
                            @:<i class="fa fa-star" style="color:#f0ad4e;"></i>
                        }
                        else
                        {
                            @:<i class="fa fa-star-o" style="color:#f0ad4e;"></i>
                        }
                    }
                    <span style="color:#777; font-size:13px; margin-left:5px;">
                        ( @ratingCount đánh giá )
                    </span>
                </span>
            }
            else
            {
                <span style="color:#777;">Chưa có đánh giá nào cho cuốn sách này. Hãy là người đầu tiên đánh giá!</span>
            }
        </div>

        @* Form gửi đánh giá *@
        @if (Session["User"] != null)
        {
            using (Html.BeginForm("SubmitRating", "Book", FormMethod.Post, new { @class = "form-horizontal", id = "ratingForm" }))
            {
                @Html.AntiForgeryToken()
                @Html.Hidden("MaSach", Model.MaSach)
                @Html.Hidden("Rating", "", new { id = "ratingValue" })

                <div class="form-group">
                    <label class="control-label col-md-2">Chọn số sao:</label>
                    <div class="col-md-10">
                        <div id="starContainer" style="font-size:24px; color:#f0ad4e; cursor:pointer;">
                            <i class="fa fa-star-o rating-star" data-value="1"></i>
                            <i class="fa fa-star-o rating-star" data-value="2"></i>
                            <i class="fa fa-star-o rating-star" data-value="3"></i>
                            <i class="fa fa-star-o rating-star" data-value="4"></i>
                            <i class="fa fa-star-o rating-star" data-value="5"></i>
                        </div>
                        <span id="ratingHelp" style="color:#999; font-size:12px;">Nhấn vào số sao để chọn (1 - 5)</span>
                    </div>
                </div>

                <div class="form-group" style="margin-top:10px;">
                    <label class="control-label col-md-2">Nhận xét:</label>
                    <div class="col-md-10">
                        <textarea name="Comment"
                                  class="form-control"
                                  rows="3"
                                  placeholder="Hãy chia sẻ cảm nhận của bạn về cuốn sách này..."></textarea>
                    </div>
                </div>

                <div class="form-group" style="margin-top:10px;">
                    <div class="col-md-offset-2 col-md-10">
                        <button type="submit" class="btn btn-success">
                            <i class="fa fa-paper-plane"></i> Gửi đánh giá
                        </button>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="alert alert-info">
                Bạn cần <a href="/User/LoginPage">đăng nhập</a> để đánh giá sản phẩm.
            </div>
        }
    </div>
</div>

<hr />

<h3 style="margin-bottom:20px;">Sách liên quan</h3>
<div class="row related-books-row">
    @Html.Action("RelatedBooks", "Book", new { id = Model.MaSach })
</div>

@section scripts{
    <script>
        $(function () {
            var selectedRating = 0;

            function renderStars(rating) {
                $('.rating-star').each(function () {
                    var value = parseInt($(this).data('value'));
                    if (value <= rating) {
                        $(this).removeClass('fa-star-o').addClass('fa-star');
                    } else {
                        $(this).removeClass('fa-star').addClass('fa-star-o');
                    }
                });
            }

            $('.rating-star').on('mouseenter', function () {
                var value = parseInt($(this).data('value'));
                renderStars(value);
            }).on('mouseleave', function () {
                renderStars(selectedRating);
            });

            $('.rating-star').on('click', function () {
                selectedRating = parseInt($(this).data('value'));
                $('#ratingValue').val(selectedRating);
                renderStars(selectedRating);
                $('#ratingHelp').text('Bạn đã chọn ' + selectedRating + ' sao.');
            });

            $('#ratingForm').on('submit', function (e) {
                if ($('#ratingValue').val() === "" || $('#ratingValue').val() === "0") {
                    alert('Vui lòng chọn số sao trước khi gửi đánh giá.');
                    e.preventDefault();
                }
            });
        });
    </script>
}
