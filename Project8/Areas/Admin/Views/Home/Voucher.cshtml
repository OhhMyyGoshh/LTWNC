@model IEnumerable<WebBanSach.Models.Data.Voucher>

@{
    ViewBag.Title = "Quản lý voucher";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}

<h2 class="page-title">Quản lý voucher</h2>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}

<p>
    @Html.ActionLink("Thêm voucher", "AddVoucher", null, new { @class = "btn btn-primary", style = "margin-bottom:10px;" })
</p>

<div class="panel panel-default">
    <div class="panel-heading" style="font-weight:600;">
        Danh sách voucher
    </div>
    <div class="table-responsive">
        <table class="table table-striped table-hover" id="voucherTable">
            <thead>
                <tr>
                    <th>Mã</th>
                    <th>Mã code</th>
                    <th>Tên voucher</th>
                    <th>Loại</th>
                    <th class="text-right">Giá trị giảm</th>
                    <th class="text-right">ĐH tối thiểu</th>
                    <th>Thời gian</th>
                    <th class="text-center">Số lượng</th>
                    <th class="text-center">Trạng thái</th>
                    <th class="text-center">Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    var now = DateTime.Now;
                    string statusText = "";
                    string statusClass = "";

                    if (!item.TrangThai.HasValue || item.TrangThai == false)
                    {
                        statusText = "Khóa";
                        statusClass = "label-default";
                    }
                    else if (item.NgayBatDau.HasValue && item.NgayBatDau.Value > now)
                    {
                        statusText = "Chưa bắt đầu";
                        statusClass = "label-info";
                    }
                    else if (item.NgayKetThuc.HasValue && item.NgayKetThuc.Value < now)
                    {
                        statusText = "Hết hạn";
                        statusClass = "label-danger";
                    }
                    else
                    {
                        statusText = "Đang áp dụng";
                        statusClass = "label-success";
                    }

                    string loaiText = "Giảm %";
                    if (item.LoaiGiamGia.HasValue && item.LoaiGiamGia.Value)
                    {
                        loaiText = "Giảm tiền";
                    }

                    string giaTriGiamText = "-";
                    if (item.GiaTriGiam.HasValue)
                    {
                        if (item.LoaiGiamGia.HasValue && item.LoaiGiamGia.Value)
                        {
                            giaTriGiamText = item.GiaTriGiam.Value.ToString("N0") + " đ";
                        }
                        else
                        {
                            giaTriGiamText = item.GiaTriGiam.Value.ToString("0.##") + " %";
                        }
                    }

                    string giaTriMinText = "-";
                    if (item.GiaTriDonHangToiThieu.HasValue)
                    {
                        giaTriMinText = item.GiaTriDonHangToiThieu.Value.ToString("N0") + " đ";
                    }

                    <tr id="row_@item.MaVoucher">
                        <td>@item.MaVoucher</td>
                        <td><strong>@item.MaCode</strong></td>
                        <td>@item.TenVoucher</td>
                        <td>@loaiText</td>
                        <td class="text-right">@giaTriGiamText</td>
                        <td class="text-right">@giaTriMinText</td>
                        <td>
                            @(item.NgayBatDau.HasValue ? item.NgayBatDau.Value.ToString("dd/MM/yyyy") : "?")
                            -
                            @(item.NgayKetThuc.HasValue ? item.NgayKetThuc.Value.ToString("dd/MM/yyyy") : "?")
                        </td>
                        <td class="text-center">@(item.SoLuong.HasValue ? item.SoLuong.Value.ToString() : "0")</td>
                        <td class="text-center">
                            <span class="label @statusClass">@statusText</span>
                        </td>
                        <td class="text-center">
                            @Html.ActionLink("Sửa", "UpdateVoucher", new { id = item.MaVoucher },
                                new { @class = "btn btn-info btn-xs", style = "margin-right:5px;" })

                            @Ajax.ActionLink("Xóa", "DeleteVoucher", new { id = item.MaVoucher },
                                new AjaxOptions
                                {
                                    Confirm = "Bạn có chắc chắn muốn xóa voucher này?",
                                    OnComplete = "$('#row_" + item.MaVoucher + "').fadeOut();",
                                    HttpMethod = "Delete"
                                },
                                new { @class = "btn btn-danger btn-xs" })
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<style>
    .page-title {
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 22px;
        font-weight: 600;
    }
</style>

@section scripts {
    <script>
        $(document).ready(function () {
            $('#voucherTable').DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Vietnamese.json"
                },
                "order": [[0, "desc"]],
                "pageLength": 10
            });
        });
    </script>
}
