@model IEnumerable<WebBanSach.Models.Data.KhachHang>

@{
    ViewBag.Title = "Quản lý người dùng";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}

<h2 class="page-header">Quản lý người dùng</h2>

<div class="panel panel-default">
    <div class="panel-heading">
        <strong>Danh sách khách hàng</strong>
    </div>
    <div class="panel-body">
        <table class="table table-striped table-bordered" id="myTable">
            <thead>
                <tr>
                    <th>Họ tên</th>
                    <th>Tài khoản</th>
                    <th>Email</th>
                    <th>Điện thoại</th>
                    <th>Ngày tạo</th>
                    <th>Trạng thái</th>
                    <th style="width:140px;">Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr id="row_@item.MaKH">
                        <td>@item.TenKH</td>
                        <td>@item.TaiKhoan</td>
                        <td>@item.Email</td>
                        <td>@item.DienThoai</td>
                        <td>@(item.NgayTao.HasValue ? item.NgayTao.Value.ToString("dd/MM/yyyy HH:mm") : "")</td>
                        <td>
                            <button type="button"
                                    class="btn btn-xs @(item.TrangThai ? "btn-success" : "btn-default") btn-toggle-user"
                                    data-id="@item.MaKH">
                                <i class="fa @(item.TrangThai ? "fa-unlock" : "fa-lock")"></i>
                                @(item.TrangThai ? " Đang hoạt động" : " Đã khóa")
                            </button>
                        </td>

                        <td class="text-right">
                            @Html.ActionLink("Chi tiết", "DetailsUser",
                                new { id = item.MaKH },
                                new { @class = "btn btn-xs btn-info" })

                            @* Nếu vẫn muốn xóa mềm thì giữ lại; nếu không thì bỏ *@
                            @*@Ajax.ActionLink("Xóa", "DeleteUser", new { id = item.MaKH }, new AjaxOptions
                                {
                                    Confirm = "Bạn có muốn xóa người dùng này không?",
                                    OnComplete = "$('#row_" + @item.MaKH + "').remove()",
                                    HttpMethod = "Delete"
                                }, new { @class = "btn btn-xs btn-danger" })*@
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>



@section jsFooter {
    <script type="text/javascript">
        $(function () {
            // Khởi tạo DataTables (nếu chưa có)
            $('#myTable').DataTable();

            // Bắt sự kiện khóa / mở
            $(document).on('click', '.btn-toggle-user', function (e) {
                e.preventDefault();

                var $btn = $(this);
                var id = $btn.data('id');

                $.ajax({
                    url: '@Url.Action("ChangeUserStatus", "Home", new { area = "Admin" })',
                    type: 'POST',
                    data: { id: id },
                    success: function (res) {
                        if (!res || !res.success) {
                            alert(res.message || 'Có lỗi khi cập nhật trạng thái.');
                            return;
                        }

                        if (res.status) {
                            // Đang hoạt động
                            $btn.removeClass('btn-default')
                                .addClass('btn-success')
                                .html('<i class="fa fa-unlock"></i> Đang hoạt động');
                        } else {
                            // Đã khóa
                            $btn.removeClass('btn-success')
                                .addClass('btn-default')
                                .html('<i class="fa fa-lock"></i> Đã khóa');
                        }
                    },
                    error: function () {
                        alert('Không thể cập nhật trạng thái, thử lại sau.');
                    }
                });
            });
        });
    </script>
}


